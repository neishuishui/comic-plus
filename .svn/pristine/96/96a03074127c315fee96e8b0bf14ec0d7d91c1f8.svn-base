<template>
  <li class="cu-sub-menu" @mouseleave="mouseleave" :class="{ 'is-active': isActive }">
    <div
      class="cu-sub-menu__head"
      ref="subMenuHead"
      v-menu-title:right-center="textLebel"
      @click="headHandleClick"
      @mouseenter="mouseenter">
      <span v-if="icon" :class="icon" class="icon"></span>
      <span>
        <slot name="label">
          {{ label }}
        </slot>
      </span>
      <span
        class="suffix-icon"
        :class="[{ open: isOpen }, injectProps.mode === 'horizontal' ? 'cu-icon-down' : 'cu-icon-right']"></span>
    </div>
    <cu-transition-collapse v-if="injectProps.mode === 'vertical'">
      <ul class="cu-sub-menu__content" v-if="isOpen">
        <slot></slot>
      </ul>
    </cu-transition-collapse>
    <teleport to="body" :disabled="teleportDisabled" v-if="injectProps.mode === 'horizontal'">
      <cu-menu-popper :visible="isOpen" :is-fixed="!teleportDisabled" @mouse-in="clearTimes" @mouse-out="createTimes">
        <ul class="cu-sub-menu__content" :style="style">
          <slot></slot>
        </ul>
      </cu-menu-popper>
    </teleport>
  </li>
</template>

<script setup lang="ts">
import { ref, inject, reactive, onMounted, onUpdated, getCurrentInstance, computed, provide } from 'vue';
import { CuTransitionCollapse } from '../../transition-collapse';
import CuMenuPopper from './menu-popper.vue';
import { useTitle } from '../../title/main';
import { submenuProps } from './submenu.props';
import { MENU_PROVIDE, SUBMENU_PROVIDE, MenuItemInstance } from './type';
defineOptions({
  name: 'CuSubMenu'
});

const props = defineProps(submenuProps);

const vMenuTitle = useTitle();
const instance = getCurrentInstance()!;

const subMenuHead = ref();
const isOpen = ref(false);
const textLebel = ref<string | undefined>('');
const activeList = reactive([]) as MenuItemInstance[];
var timer;

onMounted(() => {
  useShowTitle();
});
onUpdated(() => {
  useShowTitle();
});

const { props: injectProps, style } = inject(MENU_PROVIDE);

const submenu = inject(SUBMENU_PROVIDE, undefined);

const teleportDisabled = computed(() => {
  return !!submenu;
});

const isActive = computed(() => {
  return activeList.filter((v) => v.isActive).length > 0;
});

const isHorizontal = computed(() => {
  return injectProps.mode === 'horizontal';
});

submenu?.setActive({
  uid: instance.uid,
  isActive
});

function useShowTitle() {
  if (subMenuHead.value.clientWidth < subMenuHead.value.scrollWidth && injectProps.showEllipsis) {
    textLebel.value = props.label;
  }
}

function headHandleClick() {
  if (isHorizontal.value) return;
  isOpen.value = !isOpen.value;
}

function mouseenter() {
  if (isHorizontal.value) {
    clearTimes();
    isOpen.value = true;
  }
}

function mouseleave() {
  if (isHorizontal.value) {
    createTimes();
  }
}

function clearTimes() {
  if (timer) {
    clearTimeout(timer);
    timer = null;
  }
}
function createTimes() {
  if (!timer) {
    timer = setTimeout(() => {
      closeMenu();
    }, 300);
  }
}

function closeMenu(deep?: boolean) {
  isOpen.value = false;
  clearTimes();
  if (deep) {
    submenu?.closeMenu(deep);
  }
}

function setActive(item: MenuItemInstance) {
  if (activeList.findIndex((v) => v.uid === item.uid) === -1) {
    activeList.push(item);
  }
}

provide(SUBMENU_PROVIDE, {
  closeMenu,
  setActive,
  isHorizontal
});
</script>
