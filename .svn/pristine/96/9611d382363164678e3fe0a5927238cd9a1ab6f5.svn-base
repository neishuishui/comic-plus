<template>
  <div
    class="cu-select"
    :class="[{ checked: show }, { 'is-disabled': disabled }, currentSize]"
    :style="{ width }"
    ref="select"
    v-click-outside:selectDropdown="onClickOutside"
  >
    <div class="cu-select__inner" @click="handleClick" @mouseover="mouseover" @mouseleave="mouseleave">
      <span v-if="multiple" class="cu-select__multiple">
        <i v-if="inputValue.length === 0" class="placeholder">{{ placeholder }}</i>
        <em v-for="op in inputValue" :key="op">
          {{ options[op] }}
          <i class="cu-icon-close-c" @click.stop="deleteOpItem(op)"></i>
        </em>
      </span>
      <input type="text" readonly :value="inputValue" :placeholder="placeholder" :disabled="disabled" v-else />
      <i class="cu-icon-bottom" v-show="!showClose || !clearable"></i>
      <i class="cu-icon-close-c" v-show="showClose" v-if="clearable" @click.stop="clear"></i>
    </div>
    <dropdown :show="show" :duration="200">
      <div class="cu-select__dropdown" outside="selectDropdown">
        <slot></slot>
      </div>
    </dropdown>
  </div>
</template>

<script setup lang="ts">
import { ref, provide, computed, inject } from 'vue';
import '../style/css';
import dropdown from '../../dropdown/src/main.vue';
import { useClickOutside } from '../../utils/directive.js';
import useItemValidate from '../../utils/mixin/validate.js';
import { useConfig } from '../../utils/config.js';
defineOptions({
  name: 'CuSelect'
});
const props = defineProps({
  modelValue: {
    type: [String, Number, Array]
  },
  multiple: Boolean,
  size: String,
  disabled: Boolean,
  width: {
    type: String,
    default: '180px'
  },
  clearable: Boolean,
  placeholder: String
});
const emit = defineEmits(['update:modelValue', 'change', 'clear']);

const { itemValidate } = useItemValidate();
const { SIZE } = useConfig();
const formSize = inject<string | null>('form:size', null);

const show = ref(false);
const select = ref();
const showClose = ref(false);
const options = ref<object>({});

const vClickOutside = useClickOutside();

const inputValue = computed(() => {
  if (props.multiple) {
    return props.modelValue;
  } else {
    return options.value[props.modelValue];
  }
});
const currentValue = computed(() => {
  return props.modelValue;
});
const currentSize = computed(() => {
  return props.size ?? formSize ?? SIZE;
});

function onClickOutside() {
  show.value && (show.value = false);
}

function optionSet(item: object) {
  if (options.value.hasOwnProperty(item.value)) return;
  options.value[item.value] = item.label;
}

function optionClick(value: string | number | string[] | number[]) {
  let val;
  if (props.multiple) {
    let arr = [...props.modelValue];
    let index = arr.findIndex((v) => v === value);
    index >= 0 ? arr.splice(index, 1) : arr.push(value);
    val = arr;
  } else {
    val = value;
    show.value = false;
  }
  emit('update:modelValue', val);
  change(val);
}

function mouseover() {
  if (props.disabled) return;
  props.modelValue && (showClose.value = true);
}

function mouseleave() {
  if (props.disabled) return;
  props.modelValue && (showClose.value = false);
}

function clear() {
  showClose.value && (showClose.value = false);
  show.value && (show.value = false);
  emit('update:modelValue', props.multiple ? [] : '');
  change(props.multiple ? [] : '');
  emit('clear');
}

function deleteOpItem(op: string | number) {
  let arr = [...props.modelValue];
  arr.splice(
    arr.findIndex((v) => v === op),
    1
  );
  emit('update:modelValue', arr);
  change(arr);
}

function handleClick() {
  if (props.disabled) return;
  show.value = !show.value;
}

function change(val: string | number | string[] | number[]) {
  emit('change', val);
  itemValidate('change');
}

provide('select:optionClick', optionClick);
provide('select:optionSet', optionSet);
provide('select:currentValue', currentValue);
provide('select:size', currentSize);
provide('select:multiple', props.multiple);

provide('parent:dom', select);
</script>
