<template>
  <Teleport to="body">
    <transition name="cu-fade" @after-enter="onAfterEnter">
      <div class="cu-mode" v-if="showMode" @click.self="modeHandleClick" :style="modeStyle">
        <transition :name="disabledTransition ? 'cu-fade-top' : 'cu-dialog'" @after-leave="onAfterLeave">
          <div class="cu-dialog" v-if="showDialog" :style="dialogStyle">
            <div class="cu-dialog__head">
              <div>
                <slot name="title"> {{ title }} </slot>
              </div>
              <i class="cu-icon-shut" @click="close" v-if="showClose"></i>
            </div>
            <div class="cu-dialog__content">
              <slot></slot>
            </div>
            <div class="cu-dialog__footer" v-if="$slots.footer">
              <slot name="footer"> </slot>
            </div>
          </div>
        </transition>
      </div>
    </transition>
  </Teleport>
</template>

<script setup lang="ts">
import { ref, watch, computed } from 'vue';
import '../style/css';
import { getMaxZIndex } from '../../utils/tools.js';
import { dialogProps, dialogEmits } from './main.props';

defineOptions({
  name: 'CuDialog'
});
const props = defineProps(dialogProps);
const emit = defineEmits(dialogEmits);

watch(
  () => props.modelValue,
  (val) => {
    if (val) {
      showMode.value = true;
    } else {
      showDialog.value = false;
    }
  }
);

const showDialog = ref(false);
const showMode = ref(false);

const dialogStyle = computed(() => {
  return {
    width: props.width || '70%',
    marginTop: props.top || '15vh',
    backgroundColor: props.color || '#fff'
  };
});

const modeStyle = computed(() => {
  return {
    zIndex: getMaxZIndex()
  };
});

function onAfterEnter() {
  showDialog.value = true;
  emit('open');
}

function onAfterLeave() {
  showMode.value = false;
  emit('update:modelValue', false);
  emit('close');
}

function modeHandleClick() {
  if (!props.modeClose) return;
  close();
}

function close() {
  if (typeof props.beforeClose === 'function') {
    props.beforeClose(done);
  } else {
    done();
  }
}
function done() {
  showDialog.value = false;
}
</script>
