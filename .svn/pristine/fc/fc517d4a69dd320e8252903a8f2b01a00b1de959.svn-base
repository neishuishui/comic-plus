<template>
  <div class="cu-color-picker__hsl" @mousedown="mousedown">
    <div class="bar" :style="barStyle"></div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, inject, watch, getCurrentInstance, onMounted } from 'vue';
import type { colorProvide } from '../type';
defineOptions({
  name: 'CuHslSlider'
});

const parent = inject<colorProvide>('color:parent');

const instance = getCurrentInstance();

const x = ref(0);

const barStyle = computed(() => {
  return {
    left: x.value + 'px'
  };
});

const hueValue = computed(() => {
  return parent?.color.get('hue');
});

watch(
  () => hueValue.value,
  (val) => {
    update(val);
  }
);
onMounted(() => {
  update(parent?.color.get('hue'));
});

function update(c: any) {
  var { clientWidth }: any = instance?.vnode.el;
  clientWidth = Math.max(clientWidth, 250);
  x.value = (c / 360) * clientWidth;
}

function mousedown(e: MouseEvent) {
  const ele = instance?.vnode.el;
  let left = e.offsetX;
  left = Math.max(0, left);
  left = Math.min(left, ele?.clientWidth);
  x.value = left;
  updateColor();
  document.addEventListener('mousemove', move);
  document.addEventListener('mouseup', up);
}

function move(e: MouseEvent) {
  const ele = instance?.vnode.el;
  let left = e.offsetX;
  left = Math.max(0, left);
  left = Math.min(left, ele?.clientWidth);
  x.value = left;
  updateColor();
}

function up() {
  document.removeEventListener('mousemove', move);
  document.removeEventListener('mouseup', up);
}

function updateColor() {
  const ele = instance?.vnode.el;
  parent && parent.color.set('hue', Math.round(360 * (x.value / ele?.clientWidth)));
}
</script>
