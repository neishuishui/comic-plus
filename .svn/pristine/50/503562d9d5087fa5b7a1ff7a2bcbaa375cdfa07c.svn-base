import { Plugin, reactive } from 'vue'
import type { Component, App } from 'vue'
import type { ComicConfig } from './export.type'
import { formRGBA, colorMixin } from './utils/color-mixin'
import { deepMerge } from './tools/index'

import components from './components'

import MessageBox from './message-box/index'
import { preview } from './preview-image/index'
import { Loading, vLoading, useLoading } from './loading/main'
import { vTitle, useTitle } from './title/main'

const plugin: Plugin = {
  install(app: App, config: object | null) {
    components.forEach((item: Component) => {
      app.use(item as unknown as { install: () => any });
    });

    app.config.globalProperties.$alert = MessageBox.alert
    app.config.globalProperties.$confirm = MessageBox.confirm
    app.config.globalProperties.$message = MessageBox.message
    app.config.globalProperties.$notice = MessageBox.notice

    app.config.globalProperties.$preview = preview
    app.config.globalProperties.$loading = Loading


    app.use(vLoading)
    app.use(vTitle)

    useComicConfig(app, config)
  },
}

var assignConfig: any = reactive({
  color: {
    primary: '#e4acc7',
  },
  size: null,
  zIndex: 2000,
})


const useComicConfig: Function = function (app: any, config: ComicConfig): void {
  if (config?.color) {
    if (typeof config.color === 'string') {
      config.color = {
        primary: config.color
      }
      setColor(config.color)

    } else if (typeof config.color === 'object') {
      setColor(config.color)
    }
  }

  assignConfig = reactive(deepMerge(assignConfig, config))

  if (app) {
    app.provide('$COMIC', assignConfig)
    window.$COMIC = assignConfig
  }
}

const setColor: Function = function (obj: object) {
  const colors = ['primary', 'success', 'danger', 'warning', 'font']
  for (const key in obj) {
    if (colors.includes(key)) {
      const c = formRGBA(obj[key]) || []
      document.body.style.setProperty(`--${key}`, `rgba(${c.join(',')})`)
      document.body.style.setProperty(`--${key}-light`, colorMixin(c, 70))
      document.body.style.setProperty(`--${key}-light2`, colorMixin(c, 10))
    } else {
      document.body.style.setProperty(`--${key}`, obj[key])
    }
  }
}

export default plugin

export * from './tools/index'
export * from './export.type'
export * from './components'

export {
  MessageBox as CuMessageBox,
  preview,
  Loading as CuLoading,
  vLoading,
  useComicConfig,
  useLoading,
  useTitle,
  vTitle
}
