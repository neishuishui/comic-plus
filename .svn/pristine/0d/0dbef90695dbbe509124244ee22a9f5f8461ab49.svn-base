<template>
  <cu-mode
    :show="showMode"
    @open="onAfterEnter"
    @close="onModeAfterLeave"
    :lock-scroll="true"
    @mode-click="showPreview = false">
    <transition name="cu-fade-top" @after-leave="onAfterLeave">
      <div class="cu-preview-image" v-show="showPreview">
        <div class="cu-preview-image__tools">
          <i class="cu-icon-close" @click="showPreview = false"></i>
          <i class="cu-icon-left" @click="minus"></i>
          <i class="cu-icon-right" @click="plus"></i>
        </div>
        <div class="cu-preview-image__imgtools">
          <i class="cu-icon-full-screen" @click="scale += 0.2"></i>
          <i class="cu-icon-off-screen" @click="scale -= 0.2"></i>
          <i class="cu-icon-undo" @click="rotate -= 90"></i>
          <i class="cu-icon-redo" @click="rotate += 90"></i>
        </div>
        <div class="cu-preview-image__pic">
          <div ref="imageBoxRef" :style="customStyle">
            <img :src="list[currentIndex]" :style="imgStyle" />
          </div>
        </div>
      </div>
    </transition>
  </cu-mode>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, nextTick } from 'vue';
import { useDraggable } from '@vueuse/core';
import '../style/preview-image.css';
import { CuMode } from '../../mode';
import { previewImageProps } from './main.props';
defineOptions({
  name: 'CuPreviewImage'
});
const props = defineProps(previewImageProps);

const showMode = ref(false);
const showPreview = ref(false);
const currentIndex = ref(0);
const scale = ref(1);
const rotate = ref(0);
const imageBoxRef = ref(null);
const initialValue = ref<any>({});

const imgStyle = computed(() => {
  return {
    transform: `scale(${scale.value}) rotate(${rotate.value}deg)`
  };
});

const { style } = useDraggable(imageBoxRef, {
  initialValue: initialValue.value
});

const customStyle = computed(() => {
  return style.value;
});

function onAfterEnter() {
  showPreview.value = true;
}

function onModeAfterLeave() {
  props.destroy?.();
}
function onAfterLeave() {
  showMode.value = false;
}

function minus() {
  currentIndex.value--;
  if (currentIndex.value < 0) {
    currentIndex.value = props.list.length - 1;
  }
}

function plus() {
  currentIndex.value++;
  if (currentIndex.value >= props.list.length) {
    currentIndex.value = 0;
  }
}

function getInitialPosition() {
  return {
    x: (window.innerWidth - imageBoxRef.value.getBoundingClientRect().width) / 2,
    y: (window.innerHeight - imageBoxRef.value.getBoundingClientRect().height) / 2
  };
}

onMounted(() => {
  showMode.value = true;
  currentIndex.value = props.current || 0;
  nextTick(() => {
    initialValue.value = getInitialPosition();
  });
});
</script>
