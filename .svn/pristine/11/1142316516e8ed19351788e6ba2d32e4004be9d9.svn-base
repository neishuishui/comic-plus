<template>
  <div class="cu-scroll-bar" :class="display" :style="{ height }">
    <div
      class="cu-scroll-bar__container"
      :style="{ 'max-height': maxHeight }"
      ref="barRef"
      @scroll="onScroll"
      v-resize="onResize"
    >
      <div v-resize="onResize">
        <slot></slot>
      </div>
    </div>
    <div class="cu-scroll-bar__thumb thumby" :style="thumbyStyle" @mousedown="mousedowny" v-if="showThumby"></div>
    <div class="cu-scroll-bar__thumb thumbx" :style="thumbxStyle" @mousedown="mousedownx" v-if="showThumbx"></div>
  </div>
</template>

<script lang="ts" setup>
import { ref, computed, nextTick, onMounted, watch } from 'vue';
import '../style/scroll-bar.css';
import { debounce, useResize } from '../../../utils';
import { scrollBarProps, scrollBarEmits } from './main.props';
defineOptions({
  name: 'CuScrollBar'
});

const props = defineProps(scrollBarProps);
const emit = defineEmits(scrollBarEmits);

const barRef = ref();
const barTop = ref(0);
const barLeft = ref(0);
const barHeight = ref(0);
const barWidth = ref(0);
const minBarSize = 16;

const vResize = useResize();
const onResize = debounce(resateScrollBar, 100);

const showThumby = ref(false);
const showThumbx = ref(false);

watch(
  () => props.display,
  () => {
    computedShowThumb();
  }
);

function computedShowThumb() {
  showThumby.value = props.display === 'none' ? false : barRef.value?.offsetHeight < barRef.value?.scrollHeight;
  showThumbx.value = props.display === 'none' ? false : barRef.value?.offsetWidth < barRef.value?.scrollWidth;
}

const thumbyStyle = computed(() => {
  return {
    '--h': Math.max(minBarSize, barHeight.value) + 'px',
    '--t': barTop.value + 'px'
  };
});

const thumbxStyle = computed(() => {
  return {
    '--w': Math.max(minBarSize, barWidth.value) + 'px',
    '--l': barLeft.value + 'px'
  };
});

function onScroll(e: Event) {
  const eTarget = <HTMLElement>e.target;
  barTop.value = (eTarget.scrollTop / eTarget.scrollHeight) * eTarget.offsetHeight;
  barLeft.value = (eTarget.scrollLeft / eTarget.scrollWidth) * eTarget.offsetWidth;

  if (barHeight.value < minBarSize) {
    barTop.value = barTop.value - ((minBarSize - barHeight.value) / eTarget.offsetHeight) * barTop.value;
  }
  if (barWidth.value < minBarSize) {
    barLeft.value = barLeft.value - ((minBarSize - barWidth.value) / eTarget.offsetWidth) * barLeft.value;
  }
  emit('scroll', e);
}

function mousedowny(e) {
  e.preventDefault();
  setTop(e.offsetY);
  document.addEventListener('mousemove', movey);
  document.addEventListener('mouseup', up);
}

function mousedownx(e) {
  e.preventDefault();
  setLeft(e.offsetX);
  document.addEventListener('mousemove', movex);
  document.addEventListener('mouseup', up);
}
function movey(e) {
  let offsetTop = barRef.value.getBoundingClientRect().top;
  setTop(e.clientY - offsetTop);
}

function movex(e) {
  let offsetLeft = barRef.value.getBoundingClientRect().left;
  setLeft(e.clientX - offsetLeft);
}

function setTop(offsetY: number) {
  let top = (offsetY / barRef.value?.offsetHeight) * barRef.value?.scrollHeight;
  top -= (barHeight.value / 2 / barRef.value?.offsetHeight) * barRef.value?.scrollHeight;
  barRef.value.scrollTo({
    top: top
  });
}

function setLeft(offsetX: number) {
  let left = (offsetX / barRef.value?.offsetWidth) * barRef.value?.scrollWidth;
  left -= (barWidth.value / 2 / barRef.value?.offsetWidth) * barRef.value?.scrollWidth;
  barRef.value.scrollTo({
    left: left
  });
}

function up(e) {
  document.removeEventListener('mousemove', movex);
  document.removeEventListener('mousemove', movey);
  document.removeEventListener('mouseup', up);
}

async function resateScrollBar() {
  await nextTick();
  const dom = barRef.value;
  if (!dom) return;
  barHeight.value = (dom.offsetHeight / dom.scrollHeight) * dom.offsetHeight;
  barWidth.value = (dom.offsetWidth / dom.scrollWidth) * dom.offsetWidth;
  barTop.value = (dom.scrollTop / dom.scrollHeight) * dom.offsetHeight;
  barLeft.value = (dom.scrollLeft / dom.scrollWidth) * dom.offsetWidth;

  if (barHeight.value < minBarSize) {
    barTop.value = barTop.value - ((minBarSize - barHeight.value) / dom.offsetHeight) * barTop.value;
  }
  if (barWidth.value < minBarSize) {
    barLeft.value = barLeft.value - ((minBarSize - barWidth.value) / dom.offsetWidth) * barLeft.value;
  }
  computedShowThumb();
}

function setBarTop(top) {
  barRef.value.scrollTo({
    top,
    behavior: 'smooth'
  });
}

function setBarLeft(left) {
  barRef.value.scrollTo({
    left,
    behavior: 'smooth'
  });
}

function getScrollEvent() {
  return barRef.value;
}

defineExpose({ setBarTop, setBarLeft, getScrollEvent, showThumby, showThumbx });

onMounted(() => {
  resateScrollBar();
});
</script>
