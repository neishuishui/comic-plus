<template>
  <label
    class="cu-checkbox"
    :style="{
      '--cu-checkbox-color': activeColor
    }"
    :class="{ 'is-disabled': disabled, 'is-check': isCheck }">
    <input type="checkbox" class="cu-checkbox__input" :checked="isCheck" :disabled="disabled" @change="changeValue" />
    <span class="cu-checkbox__inner" :class="{ indeterminate }">
      <i
        v-if="typeof props.indeterminate === 'boolean'"
        :class="modelValue ? 'cu-icon-check ' : indeterminate ? 'cu-icon-minus' : ''"></i>
      <i v-else class="cu-icon-check" v-show="isCheck"></i>
    </span>
    <span class="cu-checkbox__label" v-if="label || $slots.default">
      <slot>{{ label }}</slot>
    </span>
  </label>
</template>

<script setup lang="ts">
import { computed, inject } from 'vue';
import '../style/checkbox.css';
import { useItemValidate } from '../../../utils';
import { checkboxProps, checkboxEmits } from './main.props';
import { CHECKBOXGROUP_PROVIDE } from './type';
defineOptions({
  name: 'CuCheckbox'
});
const props = defineProps(checkboxProps);
const emit = defineEmits(checkboxEmits);

const checkboxGroup = inject(CHECKBOXGROUP_PROVIDE, undefined);

const { itemValidate } = useItemValidate();

const isCheck = computed(() => {
  if (checkboxGroup) {
    return checkboxGroup?.activeValue.value.includes(props.value ?? props.label);
  } else {
    return typeof props.modelValue === 'boolean' ? props.modelValue : props.modelValue === props.value;
  }
});

function changeValue(e: MouseEvent) {
  const eTarget = e.target as HTMLInputElement;

  if (checkboxGroup) {
    checkboxGroup.changeItemCheck(eTarget.checked, props.value ?? props.label);
    itemValidate('change');
    return;
  } else {
    let checkValue = eTarget.checked ? props.value ?? eTarget.checked : props.falseValue ?? eTarget.checked;

    emit('update:modelValue', checkValue);
    emit('change', checkValue);
    itemValidate('change');
  }
}
</script>
