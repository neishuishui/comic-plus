import type { ObjectDirective } from 'vue';

const SCOPE = '__CLICK_OUTSIDE__';

const useClickOutside = function (): ObjectDirective {
  return {
    mounted(el, binding) {
      function eventHandler(e: Event) {
        if (el.contains(<HTMLElement>e.target) || hasParent(e.target, binding.arg)) {
          return false;
        }
        if (binding.value && typeof binding.value === 'function') {
          binding.value(e);
        }
      }
      el[SCOPE] = eventHandler;
      document.addEventListener('click', eventHandler);
    },
    beforeUnmount(el) {
      document.removeEventListener('click', el[SCOPE]);
      delete el[SCOPE];
    }
  };
};
/**
 * @description: 是否存在指定父元素
 * @param {HTMLElement} ele
 * @param {string} attr
 * @return {*}
 * @author: 陈龙
 * @logic:
 */
const hasParent = function (ele: HTMLElement, attr: string): boolean {
  if (!attr) return false;
  let parent: HTMLElement | null = ele;
  let flag = false;
  while (parent && !flag) {
    let attrs = parent.getAttribute('outside');
    parent = parent.parentElement || null;
    if (attrs && attrs === attr) {
      flag = true;
    }
  }
  return flag;
};

export { useClickOutside };
