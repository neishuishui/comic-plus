<template>
  <li
    class="cu-menu-item"
    @click="itemClick"
    :class="{ 'is-active': isActive }"
    ref="cuMenuItem"
    v-menu-title:right-center="textLebel">
    <span v-if="icon" :class="icon" class="icon"></span>
    <span>
      <slot>{{ label }}</slot>
    </span>
  </li>
</template>

<script setup lang="ts">
import { inject, computed, ref, onMounted, onUpdated, getCurrentInstance } from 'vue';
import { useTitle } from '../../title/main';
import { menuItemProps } from './item.props';
import { MENU_PROVIDE, SUBMENU_PROVIDE } from './type';
defineOptions({
  name: 'CuMenuItem'
});
const props = defineProps(menuItemProps);

const vMenuTitle = useTitle();
const cuMenuItem = ref();
const instance = getCurrentInstance()!;
const textLebel = ref<string | undefined>('');

onMounted(() => {
  useShowTitle();
});
onUpdated(() => {
  useShowTitle();
});

const { props: injectProps, useItemClick } = inject(MENU_PROVIDE);
const submenu = inject(SUBMENU_PROVIDE, undefined);

const isActive = computed(() => {
  if (injectProps.modelValue) {
    return injectProps.modelValue == props.index;
  }
  return false;
});

submenu?.setActive({
  uid: instance.uid,
  isActive
});

function useShowTitle() {
  if (cuMenuItem.value.clientWidth < cuMenuItem.value.scrollWidth && injectProps.showEllipsis) {
    textLebel.value = props.label;
  }
}

function itemClick() {
  useItemClick(props.index);
  if (submenu?.isHorizontal.value) {
    submenu?.closeMenu(true);
  }
}
</script>
