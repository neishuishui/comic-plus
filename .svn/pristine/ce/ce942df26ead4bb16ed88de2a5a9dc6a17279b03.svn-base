<template>
  <div class="cu-step-card" :class="{ finish: isFinish, active: isCurrent && !error, error }">
    <div class="cu-step-card__header">
      <i :class="currentIcon" v-if="currentIcon" class="cu-step-item__icon"></i>
      <slot name="title">
        {{ title }}
      </slot>
    </div>
    <i
      :class="injectProps.direction === 'vertical' ? 'cu-icon-double-down' : 'cu-icon-double-right'"
      class="card-bridge"></i>
  </div>
</template>

<script setup lang="ts">
import { getCurrentInstance, computed, inject, onMounted, onBeforeUnmount } from 'vue';
import { stepItemProps } from './item.props';
import { STEP_PROVIDE } from './type';
defineOptions({
  name: 'CuStepCard'
});
const props = defineProps(stepItemProps);
const instance = getCurrentInstance()!;
const { props: injectProps, addItem, removeItem, itemList } = inject(STEP_PROVIDE);

const isFinish = computed(() => {
  if (!injectProps.active) return false;
  return itemList.value.findIndex((id) => id === instance.uid) < injectProps.active;
});

const isCurrent = computed(() => {
  if (injectProps.active === null || injectProps.active === undefined) return false;
  return currentIndex.value === injectProps.active;
});

const currentIndex = computed(() => {
  return itemList.value.findIndex((id: number) => id === instance.uid);
});

const currentIcon = computed(() => {
  if (props.icon) return props.icon;
  if (isCurrent.value) {
    return props.error ? 'cu-icon-close' : false;
  }
  return false;
});

onMounted(() => {
  addItem(instance.uid);
});
onBeforeUnmount(() => {
  removeItem(instance.uid);
});
</script>
